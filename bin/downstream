#!/usr/bin/env node

const config = require('config')
const readline = require('readline')
const io = require('socket.io-client')

const uri = process.argv[2] || `http://localhost:${config.get('port')}`
const socket = io(uri)
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
})

function log (...args) {
  console.log()
  console.log(...args)
}

function addTorrent (uri) {
  socket.emit('add', uri)
}

function getInput () {
  rl.question('>>> ', answer => {
    const args = answer.split(' ')
    if (args[0] === 'add') {
      addTorrent(args[1])
    }

    getInput()
  })
}

socket.on('connect', () => {
  log(`Connection established to ${uri}`)
  getInput()
})

socket.on('disconnect', () => {
  log(`Disconnected from ${uri}`)
})

socket.on('torrentAdded', torrent => {
  log('New Torrent Added', torrent.magnetUri)
})

socket.on('torrentDownload', torrent => {
  log(`[${torrent.magnetUri}] ${(torrent.progress * 100).toFixed(2)}%`)
})

socket.on('torrentDone', uri => {
  log('Torrent Complete', uri)
})

socket.on('torrentMoveError', err => {
  log('Error Moving Torrent', err)
})
